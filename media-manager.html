<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="icon" type="image/png" href="./assets/img/favicon.png">
    <title>Â™í‰ΩìÁÆ°ÁêÜ - Firebase Storage</title>

    <link id="pagestyle" href="./assets/css/soft-design-system-pro.min.css?v=1.0.9" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.3/jquery.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- Firebase ÈÖçÁΩÆ -->
    <script src="./firebase-config.js"></script>

    <style>
        :root {
            --primary-color: #ff557d;
            --secondary-color: #ff8da1;
        }

        body {
            background: linear-gradient(135deg, #ffeef3 0%, #fff5f7 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(255, 85, 125, 0.1);
        }

        .header h1 {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .btn-back {
            position: fixed;
            top: 20px;
            left: 20px;
            background: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            z-index: 1000;
        }

        .upload-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(255, 85, 125, 0.1);
        }

        .upload-area {
            border: 3px dashed var(--primary-color);
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fff5f7;
        }

        .upload-area:hover {
            background: #ffe4e9;
            border-color: var(--secondary-color);
        }

        .upload-area.dragover {
            background: #ffd4e1;
            border-color: var(--primary-color);
            transform: scale(1.02);
        }

        .btn-upload {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .btn-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 85, 125, 0.3);
        }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .media-item {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .media-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(255, 85, 125, 0.2);
        }

        .media-item img,
        .media-item video {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .media-info {
            padding: 15px;
        }

        .media-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .media-size {
            color: #999;
            font-size: 12px;
        }

        .media-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-action {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn-copy {
            background: #e3f2fd;
            color: #1976d2;
        }

        .btn-copy:hover {
            background: #bbdefb;
        }

        .btn-delete {
            background: #ffebee;
            color: #d32f2f;
        }

        .btn-delete:hover {
            background: #ffcdd2;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            transition: width 0.3s ease;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #999;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab:hover {
            color: var(--secondary-color);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            color: #999;
            font-size: 14px;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .media-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .header h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>

<body>
    <a href="index.html" class="btn-back">‚Üê ËøîÂõûÈ¶ñÈ°µ</a>

    <div class="container" id="mainContent" style="display: none;">
        <!-- Â§¥ÈÉ® -->
        <div class="header">
            <h1>üìÅ Â™í‰ΩìÊñá‰ª∂ÁÆ°ÁêÜ</h1>
            <p>ÁÆ°ÁêÜÁÖßÁâáÂíåËßÜÈ¢ë - Firebase Storage</p>
        </div>

        <!-- ÁªüËÆ°‰ø°ÊÅØ -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalFiles">0</div>
                <div class="stat-label">ÊÄªÊñá‰ª∂Êï∞</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSize">0 MB</div>
                <div class="stat-label">ÊÄªÂ§ßÂ∞è</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="photoCount">0</div>
                <div class="stat-label">ÁÖßÁâá</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="videoCount">0</div>
                <div class="stat-label">ËßÜÈ¢ë</div>
            </div>
        </div>

        <!-- ‰∏ä‰º†Âå∫Âüü -->
        <div class="upload-section">
            <h3 style="color: var(--primary-color); margin-bottom: 20px;">üì§ ‰∏ä‰º†Êñá‰ª∂</h3>

            <!-- ÂàÜÁ±ªÈÄâÊã© -->
            <div style="margin-bottom: 20px;">
                <label style="margin-right: 20px;">
                    <input type="radio" name="category" value="photos" checked> ÁÖßÁâáÂ¢ô
                </label>
                <label style="margin-right: 20px;">
                    <input type="radio" name="category" value="secretPhotos"> ÁßòÂØÜÁõ∏ÂÜå
                </label>
                <label style="margin-right: 20px;">
                    <input type="radio" name="category" value="videos"> ËßÜÈ¢ë
                </label>
                <label>
                    <input type="radio" name="category" value="calendar"> Êó•ÂéÜ‰∫ã‰ª∂
                </label>
            </div>

            <!-- ÊãñÊîæÂå∫Âüü -->
            <div class="upload-area" id="dropZone">
                <p style="font-size: 48px; margin: 0;">üìÅ</p>
                <p style="font-size: 18px; color: var(--primary-color); margin: 10px 0;">ÊãñÊîæÊñá‰ª∂Âà∞ËøôÈáå</p>
                <p style="color: #999;">ÊàñËÄÖ</p>
                <input type="file" id="fileInput" multiple accept="image/*,video/*" style="display: none;">
                <button class="btn-upload" onclick="document.getElementById('fileInput').click()">ÈÄâÊã©Êñá‰ª∂</button>
            </div>

            <!-- ‰∏ä‰º†ËøõÂ∫¶ -->
            <div id="uploadProgress" style="display: none; margin-top: 20px;">
                <p id="uploadStatus">Ê≠£Âú®‰∏ä‰º†...</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Êñá‰ª∂ÂàóË°® -->
        <div class="upload-section">
            <h3 style="color: var(--primary-color); margin-bottom: 20px;">üìã Â∑≤‰∏ä‰º†ÁöÑÊñá‰ª∂</h3>

            <!-- Ê†áÁ≠æÈ°µ -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('all')">ÂÖ®ÈÉ®</button>
                <button class="tab" onclick="switchTab('photos')">ÁÖßÁâáÂ¢ô</button>
                <button class="tab" onclick="switchTab('secretPhotos')">ÁßòÂØÜÁõ∏ÂÜå</button>
                <button class="tab" onclick="switchTab('videos')">ËßÜÈ¢ë</button>
                <button class="tab" onclick="switchTab('calendar')">Êó•ÂéÜ</button>
            </div>

            <!-- Êñá‰ª∂ÁΩëÊ†º -->
            <div class="media-grid" id="mediaGrid">
                <!-- Âä®ÊÄÅÂä†ËΩΩ -->
            </div>
        </div>
    </div>

    <script>
        const PASSWORD = 'xp9174110';
        let storage, storageRef, mediaCollection;
        let currentTab = 'all';
        let mediaFiles = [];

        // È°µÈù¢Âä†ËΩΩÊó∂È™åËØÅÂØÜÁ†Å
        window.addEventListener('DOMContentLoaded', async function() {
            await checkPassword();
        });

        // ÂØÜÁ†ÅÈ™åËØÅ
        async function checkPassword() {
            const result = await Swal.fire({
                title: 'üîí ÁÆ°ÁêÜÂëòÈ™åËØÅ',
                text: 'ËØ∑ËæìÂÖ•ÂØÜÁ†Å',
                input: 'password',
                inputAttributes: {
                    autocapitalize: 'off',
                    autocorrect: 'off'
                },
                showCancelButton: true,
                cancelButtonText: 'ËøîÂõû',
                confirmButtonText: 'Á°ÆËÆ§',
                allowOutsideClick: false,
                allowEscapeKey: false
            });

            if (result.isConfirmed && result.value === PASSWORD) {
                document.getElementById('mainContent').style.display = 'block';
                await initFirebase();
                await loadMedia();
            } else {
                window.location.href = 'index.html';
            }
        }

        // ÂàùÂßãÂåñ Firebase
        async function initFirebase() {
            return new Promise((resolve) => {
                const check = setInterval(() => {
                    if (window.firebaseDb) {
                        storage = window.firebaseDb.storage;
                        storageRef = window.firebaseDb.storageRef;
                        mediaCollection = window.firebaseDb.mediaCollection;
                        clearInterval(check);
                        resolve();
                    }
                }, 100);
            });
        }

        // Êñá‰ª∂‰∏ä‰º†
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        // ÊãñÊîæ‰∫ã‰ª∂
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            uploadFiles(files);
        });

        // Êñá‰ª∂ÈÄâÊã©
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            uploadFiles(files);
        });

        // ‰∏ä‰º†Êñá‰ª∂
        async function uploadFiles(files) {
            if (files.length === 0) return;

            const category = document.querySelector('input[name="category"]:checked').value;
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadStatus = document.getElementById('uploadStatus');
            const progressFill = document.getElementById('progressFill');

            uploadProgress.style.display = 'block';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                uploadStatus.textContent = `Ê≠£Âú®‰∏ä‰º† ${i + 1}/${files.length}: ${file.name}`;

                try {
                    // ‰∏ä‰º†Âà∞ Storage
                    const path = window.firebaseDb.STORAGE_PATHS[category] + file.name;
                    const fileRef = storageRef.child(path);

                    const uploadTask = fileRef.put(file);

                    await new Promise((resolve, reject) => {
                        uploadTask.on('state_changed',
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                progressFill.style.width = progress + '%';
                            },
                            reject,
                            resolve
                        );
                    });

                    // Ëé∑Âèñ‰∏ãËΩΩ URL
                    const downloadURL = await fileRef.getDownloadURL();

                    // ‰øùÂ≠òÂÖÉÊï∞ÊçÆÂà∞ Firestore
                    await mediaCollection.add({
                        name: file.name,
                        path: path,
                        url: downloadURL,
                        category: category,
                        size: file.size,
                        type: file.type,
                        uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                } catch (error) {
                    console.error('‰∏ä‰º†Â§±Ë¥•:', error);
                    await Swal.fire({
                        icon: 'error',
                        title: '‰∏ä‰º†Â§±Ë¥•',
                        text: `${file.name} ‰∏ä‰º†Â§±Ë¥•: ${error.message}`
                    });
                }
            }

            uploadProgress.style.display = 'none';
            fileInput.value = '';

            await Swal.fire({
                icon: 'success',
                title: '‰∏ä‰º†ÊàêÂäüÔºÅ',
                text: `ÊàêÂäü‰∏ä‰º† ${files.length} ‰∏™Êñá‰ª∂`,
                timer: 2000
            });

            await loadMedia();
        }

        // Âä†ËΩΩÂ™í‰ΩìÊñá‰ª∂
        async function loadMedia() {
            const snapshot = await mediaCollection.get();
            mediaFiles = [];

            snapshot.forEach(doc => {
                mediaFiles.push({
                    id: doc.id,
                    ...doc.data()
                });
            });

            // Êåâ‰∏ä‰º†Êó∂Èó¥ÂÄíÂ∫è
            mediaFiles.sort((a, b) => {
                if (!a.uploadedAt || !b.uploadedAt) return 0;
                return b.uploadedAt.toMillis() - a.uploadedAt.toMillis();
            });

            updateStats();
            displayMedia();
        }

        // Êõ¥Êñ∞ÁªüËÆ°
        function updateStats() {
            const totalSize = mediaFiles.reduce((sum, file) => sum + (file.size || 0), 0);
            const photos = mediaFiles.filter(f => f.type && f.type.startsWith('image')).length;
            const videos = mediaFiles.filter(f => f.type && f.type.startsWith('video')).length;

            document.getElementById('totalFiles').textContent = mediaFiles.length;
            document.getElementById('totalSize').textContent = (totalSize / 1024 / 1024).toFixed(2) + ' MB';
            document.getElementById('photoCount').textContent = photos;
            document.getElementById('videoCount').textContent = videos;
        }

        // ÊòæÁ§∫Â™í‰ΩìÊñá‰ª∂
        function displayMedia() {
            const grid = document.getElementById('mediaGrid');
            let filteredFiles = mediaFiles;

            // Â∫îÁî®ËøáÊª§
            if (currentTab !== 'all') {
                filteredFiles = mediaFiles.filter(f => f.category === currentTab);
            }

            if (filteredFiles.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ÊöÇÊó†Êñá‰ª∂</p>';
                return;
            }

            grid.innerHTML = filteredFiles.map(file => {
                const isVideo = file.type && file.type.startsWith('video');
                const size = file.size ? (file.size / 1024 / 1024).toFixed(2) + ' MB' : 'Êú™Áü•';

                return `
                    <div class="media-item">
                        ${isVideo ?
                            `<video src="${file.url}" controls></video>` :
                            `<img src="${file.url}" alt="${file.name}">`
                        }
                        <div class="media-info">
                            <div class="media-name" title="${file.name}">${file.name}</div>
                            <div class="media-size">${size}</div>
                            <div class="media-actions">
                                <button class="btn-action btn-copy" onclick="copyURL('${file.url}')">Â§çÂà∂ÈìæÊé•</button>
                                <button class="btn-action btn-delete" onclick="deleteFile('${file.id}', '${file.path}')">Âà†Èô§</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ÂàáÊç¢Ê†áÁ≠æÈ°µ
        function switchTab(tab) {
            currentTab = tab;

            // Êõ¥Êñ∞Ê†áÁ≠æÊ†∑Âºè
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            displayMedia();
        }

        // Â§çÂà∂URL
        async function copyURL(url) {
            try {
                await navigator.clipboard.writeText(url);
                await Swal.fire({
                    icon: 'success',
                    title: 'Â∑≤Â§çÂà∂ÔºÅ',
                    text: 'URL Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø',
                    timer: 1500,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Â§çÂà∂Â§±Ë¥•:', error);
            }
        }

        // Âà†Èô§Êñá‰ª∂
        async function deleteFile(docId, path) {
            const result = await Swal.fire({
                title: 'Á°ÆËÆ§Âà†Èô§Ôºü',
                text: 'Âà†Èô§ÂêéÊó†Ê≥ïÊÅ¢Â§ç',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Á°ÆËÆ§Âà†Èô§',
                cancelButtonText: 'ÂèñÊ∂à',
                confirmButtonColor: '#d32f2f'
            });

            if (result.isConfirmed) {
                try {
                    // ‰ªé Storage Âà†Èô§
                    await storageRef.child(path).delete();

                    // ‰ªé Firestore Âà†Èô§
                    await mediaCollection.doc(docId).delete();

                    await Swal.fire({
                        icon: 'success',
                        title: 'Â∑≤Âà†Èô§',
                        timer: 1500,
                        showConfirmButton: false
                    });

                    await loadMedia();
                } catch (error) {
                    console.error('Âà†Èô§Â§±Ë¥•:', error);
                    await Swal.fire({
                        icon: 'error',
                        title: 'Âà†Èô§Â§±Ë¥•',
                        text: error.message
                    });
                }
            }
        }
    </script>
</body>

</html>
